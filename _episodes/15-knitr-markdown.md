---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 15-knitr-markdown.md in _episodes_rmd/
title: Producing Reports With knitr
teaching: 60
exercises: 15
questions:
- "How can I integrate software and reports?"
objectives:
- Value of reproducible reports
- Basics of Markdown
- R code chunks
- Chunk options
- Inline R code
- Other output formats
keypoints:
- "Mix reporting written in R Markdown with software written in R."
- "Specify chunk options to control formatting."
- "Use `knitr` to convert these documents into PDF and other formats."
source: Rmd
---




## データ分析報告

データ分析家は、協力者や、将来参照する文章として、分析及び結果を記した
報告を数多く書く傾向にあります。

私が始めたばかりの頃は、全ての仕事についてRスクリプトを書いて、
結果を説明し、様々なグラフを添付したメールを協力者に送信していました。
結果を議論する際、どれがどのグラフが混乱してしまうこともよくありました。

WordやLaTeXで正式な報告を書く段階に移りましたが、図が正しく見えるように
するために、かなり多くの時間を費やしました。大抵の場合、ページ分けが、
悩ましかったです。

今では、ウェブページ（htmlファイル）を作るようになり全てが簡単になりました。
ひとつの長くつづくページなりますので、普通の１ページに収まらないような高さがある図
でも全て入れることができます。味方は、スクロールですね。


## 読み書きできるプログラミング

分析報告書のようなものは、_再現できる_ 文書であることが理想です。つまり、
エラーが見つかった場合や、データに追加があった場合、単に報告書を
再コンパイルすれば、新しい、または正しい結果が得られるという形です。
（その反対は、図を再作成し、Word文書に貼り付け、更に手作業で
様々な詳細結果に手を加えなえればならないという形です）

Rでカギとなるツールは [knitr](http://yihui.name/knitr/) です。これは、
コードの塊と文章が混ざった文書を作成してくれるものです。
文書が、knitrで処理される際に、Rコードの塊が実行され、
グラフと他の結果が挿入されます。

こういうものを「読み書きできるプログラミン（literate programming）」と呼びます。

knitrは、基本的にどんなテキストでも、どんなコードでも、一緒に使えますが、
お勧めは、RにMarkdownを合体させた、R Markdownです。
Markdownは、ウェブページを作るための軽いマークアップ言語です。


## R Markdownファイルの作成

R Studioで、File &rarr; New File &rarr; R Markdown をクリックしましょう。
すると、次のようなダイアログボックスが出ます：

![](../fig/New_R_Markdown.png)

デフォルト（HTML output）のままでよいので、タイトルを付けましょう。


## R Markdownの基本構成要素

最初のテキストの塊は、Rへの説明となります。つまり、
タイトル、著者者、日付といったものを書き込み、
html（つまりウェブページを）出力したいということを伝えましょう。

```
---
title: "Initial R Markdown document"
author: "Karl Broman"
date: "April 23, 2015"
output: html_document
---
```

入れたくなければ、これらのフィールドのいずれも消すことができます。
この場合、この二重引用符は、厳密には _必須_ ではありません。
必要になる時は、大抵、タイトルにコロンを含めたいというときです。

RStudioは、始めやすいように、テキストの例の文書を作成します。
以下にあるように、塊はこんな感じです：

<pre>
&#96;&#96;&#96;{r}
summary(cars)
&#96;&#96;&#96;
</pre>

knitrが実行するRコードの塊があり、それは結果に置き換えられます。
また後ほど、詳しくお伝えします。

`**Knit**` の中にある、二重アスタリスクと、かぎ括弧（ `< >` ）の間に置かれているウェブアドレスが
あるのが分かるでしょう。これが、[Markdown](http://daringfireball.net/projects/markdown/syntax)なのです。

## Markdown

Markdownは、htmlコードを書くというよりも、メールを書くときにするような形で、
テキストに印をつけていきながらウェブページを書く体系のひとつです。印がつけられた（marked-up）
テキストは、マークが指し示す正しいhtmlコードに置き換えられながら、htmlに _変換_ されます。

とりあえず、ここにあるものを全部消して、少しMarkdownを書いてみましょう。

二重アスタリスクを使って、 **太字** に（例 `**bold**`）、
下線を使って、 _斜体_ にすることもできます（例 `_italics_`）。

ハイフンやアスタリスクを使って、箇条書きを書くこともできます。例えば：

```
* 太字は、二重アスタリスクで
* 斜体は、下線で
* コードタイプのフォントは括弧で
```

または、このように：

```
- 太字は、二重アスタリスクで
- 斜体は、下線で
- コードタイプのフォントは括弧で
```

それぞれ、以下の形で表示されます：

- 太字は、二重アスタリスクで
- 斜体は、下線で
- コードタイプのフォントは括弧で

（私はハイフンよりもアスタリスクの方が好きですが）

数字を使って番号付きリストを作ることもできます。
同じ番号を何度でも好きなだけ使えます：

```
1. 太字は、二重アスタリスクで
1. 斜体は、下線で
1. コードタイプのフォントは括弧で
```

これは、次のように表示されます：

1. 太字は、二重アスタリスクで
1. 斜体は、下線で
1. コードタイプのフォントは括弧で

行の頭に `#` 印を好きな数つけることで、色々なサイズの文節の題名を作ることができます：

```
# タイトル
## 主文節
### 副文節
#### 更なる副文節
```

左上にある「Knit HTML」をクリックすることで、R Markdown文書を、html ウェブサイトへ _コンパイル_ する
ことができます。その隣に、小さな疑問符があるのが分かると思います。その疑問符をクリックしてみると、
R MarkdownについてのRStudio文書と、「Markdown Quick Reference」（Markdownのシンタックス付き）
が出てくることでしょう。

> ## チャレンジ1
>
> 新しいR Markdown文書を作りましょう。Rコードの塊を全て消して、
> Markdown（いくつかの文節、斜体テキスト、箇条書き）
> を書いてみましょう。
>
> この文書をウェブサイトにしてみましょう。
{: .challenge}


## もうちょっとMarkdownについて

次のような、ハイパーリンクを作ることができます：
`[表示するテキスト](http://the-web-page.com)`.

このようなイメージを含めることもできます：`![caption](http://url/for/file)`

下付き文字 （例 F~2~）も `F~2` で、上付き文字（例 F^2^）も `F^2^` でできます。

もし、[LaTeX](http://www.latex-project.org/)の等式の書き方を知っていれば、
`$ $` と `$$ $$` が数式を挿入するのに使えると知って嬉しいことでしょう。
例えば、 `$E = mc^2$` や、

```
$$y = \mu + \sum_{i=1}^p \beta_i x_i + \epsilon$$
```



## Rコードの塊

Markdownは、面白く役に立つものですが、ミソは、Rコードの塊とMarkdownが混ぜられることなのです。
それが、R Markdownですね。処理すると、Rコードが実行され、図が作られ、最終的な文書に挿入されます。

メインコードの塊は、こんな感じです：

<pre>
&#96;&#96;&#96;{r load_data}
gapminder <- read.csv("~/Desktop/gapminder.csv")
&#96;&#96;&#96;
</pre>

つまり、Rコードの塊を<code>&#96;&#96;&#96;{r chunk_name}</code>
と<code>&#96;&#96;&#96;</code>の間に置くのです。それぞれの重複しない名前を付けておくといいでしょう。
そうすると、エラーを修正するときに役立ちますし、グラフのファイル名は、それが生成されたコードの塊の名前に基づいて付けられるからです。

> ## チャレンジ1
>
> 以下を行うコードの塊を加えましょう
>
> - ggplot2 パッケージの読み込み
> - gapminder データの読み込み
> - プロットの作成
{: .challenge}

## どうコンパイルされるか

「Knit HTML」ボタンを押すと、R Markdown文書は、[knitr](http://yihui.name/knitr)
によって処理され、単純なMarkdown文書が（一連の図のファイルと共に）生成されます。
Rコードは、実行され、入力と出力に置き換わります。図が生成された場合、
これらの図へのリンクが挿入されます。

Markdownと図の文書は、[pandoc](http://pandoc.org/) というツールで処理され、
Markdownファイルが、図が埋め込まれたhtmlファイルに変換されます。

<img src="../fig/rmd-15-rmd_to_html_fig-1.png" title="plot of chunk rmd_to_html_fig" alt="plot of chunk rmd_to_html_fig" style="display: block; margin: auto auto auto 0;" />




## 塊のオプション

コードの塊がどう扱われるかに関して色々なオプションがあります。

- コード自体を見せないためには、 `echo=FALSE` を使います
- 結果を表示しないためには、 `results="hide"` を使います
- コードを演算せず表示するためには、 `eval=FALSE` を使います
- 警告メッセージが出た場合、隠す場合は、 `warning=FALSE` と `message=FALSE` を使います
- 生成される図の大きさを（インチで）管理するためには、 `fig.height` と `fig.width` を使います

なので、書くとすれば：

<pre>
&#96;&#96;&#96;{r load_libraries, echo=FALSE, message=FALSE}
library("dplyr")
library("ggplot2")
&#96;&#96;&#96;
</pre>

よくあることですが、何度も使いたいオプションが出てくることあることでしょう。
その際は、 _global_options_ を使います。例えば：

<pre>
&#96;&#96;&#96;{r global_options, echo=FALSE}
knitr::opts_chunk$set(fig.path="Figs/", message=FALSE, warning=FALSE,
                      echo=FALSE, results="hide", fig.width=11)
&#96;&#96;&#96;
</pre>

 `fig.path` オプションは、図がどこに保存されるかを定義します。
ここで、 `/` は、とても重要で、もしこれがなければ、図は標準的な場所に
保存されますが、 `Figs` で始まる名前だけになります。

共有ディレクトリにR Markdownファイルが複数ある場合は、
 `fig.path` を図のファイル名に異なる接頭語を付けるために使うといいかもしれません。
例えば、`fig.path="Figs/cleaning-"` and `fig.path="Figs/analysis-"` のように。


> ## チャレンジ1
>
> 図の大きさを管理し、コードを隠す塊のオプションを使ってみましょう。
{: .challenge}


## 文中のRコード

報告書にある、_それぞれの_ 数を再現可能なものにすることができます。
<code>&#96;r</code> と <code>&#96;</code> を文中のコードの塊に使ってみましょう。
例えば： <code>&#96;r round(some_value, 2)&#96;</code>。コードは、
実行され、結果の _値_ に置き換えられます。

この文中の塊を、複数の行に分けて入れないようにしましょう。

パラグラフの前には、 おそらく、`include=FALSE` と設定された（これは `echo=FALSE` と `results="hide"` と同じ）
より大きな物事の定義や演算を行うコードの塊があるはずです。

このような場合、出力された数の丸め方によって違いがでることがあります。
`2.0` が欲しくても、`round(2.03, 1)` では、ただの `2` が出てきてしまいます。

[R/broman](https://github.com/kbroman)パッケージにある、
[`myround`](https://github.com/kbroman/broman/blob/master/R/myround.R)関数が、
この問題に対処してくれます。

> ## チャレンジ1
>
> 文中のRコードを少し試してみましょう。
{: .challenge}


## 他の出力オプション

R MarkdownをPDFやWord文書に変換することもできます。
ドロップダウンメニューを表示させるために、「Knit HTML」の横にある小さい三角をクリックしましょう。
または、 `pdf_document` や `word_document` をファイルの最初のヘッダーに入れておくこともできます。

> ## ヒント：PDFドキュメントの作成
>
> .pdf文書を作成するためには、いくつかソフトウェアをインストールしなければいけないかもしれません。
> もし、必要な場合、エラーメッセージの中に詳細が述べられています。
>
> - [Windows向けのTeXインストーラー](https://miktex.org/2.9/setup).
> - [macOS向けのTeXインストーラー](https://tug.org/mactex).
{: .callout}


## 資料

- [Knitr in a knutshell tutorial](http://kbroman.org/knitr_knutshell)
- [Dynamic Documents with R and knitr](http://www.amazon.com/exec/obidos/ASIN/1482203537/7210-20) (book)
- [R Markdown documentation](http://rmarkdown.rstudio.com)
- [R Markdown cheat sheet](http://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf)
* [Getting started with R Markdown](https://www.rstudio.com/resources/webinars/getting-started-with-r-markdown/)
* [Reproducible Reporting](https://www.rstudio.com/resources/webinars/reproducible-reporting/)
* [The Ecosystem of R Markdown](https://www.rstudio.com/resources/webinars/the-ecosystem-of-r-markdown/)
* [Introducing Bookdown](https://www.rstudio.com/resources/webinars/introducing-bookdown/)

